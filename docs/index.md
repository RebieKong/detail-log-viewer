# DetailLogViewer-用户流水数据查询方案

## 简介

### 解决的难题

1. 单个用户数据检索慢的问题
2. 大量用户数据管理复杂的问题
3. 单个实人具有多个用户标识的分页和读取麻烦的问题 
4. 数据初始化速度慢，恢复麻烦的问题
5. 以前的系统较难对接实时系统的问题

### 技术选择

1. 数据储存方案采用Phoenix+HBase的方案
2. 使用Spark来写入phoenix
3. 使用Phoenix的thin-server来读取数据

### 需要注意的问题

1. 写入HBase时仍旧使用的是HBase的API,而不是BulkLoad的方式
2. 修改表结构时对读方影响较大
3. 数据表需要合适的区分列族以保证性能和可靠性

## 实施方案

### 模型设计

1. PK的设计
    1. PK的组成与顺序
    
        主键是一行记录的唯一标识，需要具有不重复和唯一性的特点。
        
        在当前场景中，主键构成分别是：
        1. 用户唯一标识
        2. 日志时间
        3. 数据签名
       
    2. 为什么要签名
    
        因为数据在写入到Hbase时可能会重复写入等现象，为了保证数据写入操作是幂等的，所以增加签名字段，但是部分数据的id必然是唯一的情况下，则不需要签名
        
2. 写入前的准备工作
    1. 修改表结构（如果有必要的话）
    2. 过滤部分脏数据（主要是PK局部为空）

### 写入操作

1. 使用Phoenix批量写入
2. 存在的问题：写入性能需要暴改

### 读取操作

1. 引入Phoenix-4.13-thin-client.jar
2. 使用url:```jdbc:phoenix:thin:url=http://phoenix_host:8765;serialization=PROTOBUF```